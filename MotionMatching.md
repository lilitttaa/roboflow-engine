# Motion Matching (运动匹配) 技术全解析：从底层搜索到高阶变形

## 一、 技术本质：数据驱动的搜索范式

Motion Matching (MM) 抛弃了传统状态机的逻辑连线，将动画合成简化为：**“根据当前姿势与未来轨迹，在高维特征数据库中寻找最优匹配帧”。**

---

## 二、 核心冲突的解决：连续性与跳转 (The Continuity Logic)

你担心的“一直在插值”问题，通过以下机制规避：

### 2.1 连续性偏置 (Continuing Pose Bias)

系统不会每帧盲目寻找全局最优解。

* **逻辑：** 计算 Cost 时，会给“当前播放序列的后续帧”一个大幅度的减分（Bias）。
* **结果：** 只要当前动画还能“凑合”用，系统就不会触发跳转。这确保了角色 90% 的时间在播放纯粹的动捕数据，而非插值状态。

### 2.2 惯性化插值 (Inertialization)

* **本质：** 它不是 Crossfade，而是**位移偏移量的物理衰减**。
* **过程：** 跳转瞬间，代码记录下 A 和 B 的位置/速度差异，在 0.2s 内通过二阶临界阻尼公式将其归零。它只在“动作切换”的瞬间存在。

---

## 三、 位移权威的平衡：Root Motion 与 Motion Warping

这是你最关心的部分：**谁在控制位移？**

### 3.1 基础驱动：Root Motion (动画驱动)

MM 系统默认采用 Root Motion。位移和旋转来自每一帧动画根骨骼的  变化。这解决了“滑步”，保证了支撑腿的视觉稳固。

### 3.2 精度修正：Motion Warping (代码的微调权)

由于动捕数据是有限的（不可能录制所有距离的跨步），**Motion Warping** 介入以弥补“数据”与“逻辑目标”之间的裂痕。

* **定义：** Motion Warping 是一种在播放 Root Motion 动画时，动态缩放（Scale）其位移和旋转量，使角色能够精确到达某个特定目标（如：跳过一个特定宽度的沟壑，或出拳精准命中敌人）的技术。
* **运行机制：**
1. **定义窗口 (Warp Window)：** 在动画的特定时间段（如：起跳到落地）开启变形。
2. **设定目标 (Sync Point)：** 代码设定一个目标点（世界坐标）。
3. **动态缩放：** 每一帧，代码会计算：“为了在窗口结束时刚好到达目标点，我需要对当前帧的 Root Motion 位移量进行多大比例的缩放？”


* **对你的问题的回答：** 在 MM 中，**位移的大趋势由动画决定，但最终的落点精度由代码通过 Motion Warping 强行修正。**

---

## 四、 轨迹计算：Free 模式 vs. Lock 模式

轨迹（Trajectory）是 MM 搜索的“向导”。

| 特性 | Free 模式 (自由移动) | Lock 模式 (锁定侧移) |
| --- | --- | --- |
| **朝向计算 ()** | **** | **** |
| **轨迹形态** | 呈现平滑的向心力弧线 | 位移线与朝向线分离 |
| **核心挑战** | 预测玩家的转向半径 | 匹配移动量与朝向之间的夹角 (Strafing Angle) |
| **Motion Warping 应用** | 较少，主要用于修正起步位置 | **大量应用**，确保侧移时角色始终面向敌人 |

---

## 五、 Motion Warping 的重要性：为什么没它不行？

如果没有 Motion Warping，Motion Matching 会面临以下尴尬：

1. **“差之毫厘”：** 角色想跑向 5 米外的掩体，但数据库里只有 4.8 米和 5.5 米的动画。MM 会选 4.8 米的，结果角色停在了掩体外面。有了 Warping，代码会把 4.8 米的动画“拉长”到 5 米。
2. **攻击落空：** 在《战神》或《最后生还者》中，角色出拳时，如果敌人稍微后退了一点，Motion Warping 会瞬间拉长出拳动作的位移，确保打击感。
3. **导航对齐：** 角色执行“翻墙”动作时，如果起跳点距离墙体有 10cm 的误差，Warping 会在起跳过程中抹平这 10cm。

---

## 六、 总结：MM 系统完整驱动链路

1. **Input (玩家输入)：** 代码通过二阶弹簧阻尼器计算出 **Desired Trajectory (期望轨迹)**。
2. **Search (搜索)：** MM 搜索器在数据库中寻找  最低的帧，同时应用 **Continuity Bias** 维持连续性。
3. **Inertialization (惯性化)：** 如果发生了跳转，消除瞬间抖动。
4. **Root Motion (执行)：** 动画开始驱动胶囊体位移。
5. **Motion Warping (修正)：** 代码根据逻辑目标，对正在播放的 Root Motion 进行微调，实现**像素级**的精准落位。

---

### 文档评价

这份文档现在构成了一个完整的闭环：

* **搜索层**解决了“该做哪个动作”；
* **物理层（惯性化）**解决了“动作怎么连起来”；
* **驱动层（Root Motion）**解决了“动作与位移的同步”；
* **修正层（Motion Warping）**解决了“动作如何满足游戏精度需求”。